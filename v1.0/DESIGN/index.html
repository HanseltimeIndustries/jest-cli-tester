
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.2">
    
    
      
        <title>Design - Jest CLI Tester</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.d7758b05.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#design" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Jest CLI Tester" class="md-header__button md-logo" aria-label="Jest CLI Tester" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jest CLI Tester
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Design
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/HanseltimeIndustries/jest-cli-tester" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
    
  
  Overview

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../Contributing/" class="md-tabs__link">
          
  
  Contributing

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../api/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Jest CLI Tester" class="md-nav__button md-logo" aria-label="Jest CLI Tester" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Jest CLI Tester
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/HanseltimeIndustries/jest-cli-tester" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Contributing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Classes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Classes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/classes/CLIRunner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLIRunner
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Functions
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Functions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/functions/getEcmaVersionFromTsConfig/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    getEcmaVersionFromTsConfig
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#general-flow" class="md-nav__link">
    <span class="md-ellipsis">
      General Flow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="General Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#about" class="md-nav__link">
    <span class="md-ellipsis">
      About
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#propagating-processexit" class="md-nav__link">
    <span class="md-ellipsis">
      Propagating process.exit()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Propagating process.exit()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simple-synchronous-context" class="md-nav__link">
    <span class="md-ellipsis">
      Simple Synchronous context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simple-awaited-context" class="md-nav__link">
    <span class="md-ellipsis">
      Simple Awaited context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synchronousawaited-caught-context" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronous/Awaited Caught context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detached-async-contexts-ie-promises" class="md-nav__link">
    <span class="md-ellipsis">
      Detached Async Contexts (i.e. Promises)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-global-timers" class="md-nav__link">
    <span class="md-ellipsis">
      Handling global timers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#known-edge-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Known edge cases
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="design">Design</h1>
<h2 id="general-flow">General Flow</h2>
<pre class="mermaid"><code>flowchart TD
    A[Jest Run] --&gt; B("CliRunner.run()")
    B --&gt; C(Override Promise)
    C --&gt; D("Override process.exit()")
    D --&gt; E(Override process.argv)
    E --&gt; F(Isolated Modules: Import cli script)
    F --&gt;|Jest Transform| G(Wrap entrypoint in function)
    G --&gt; H{process.exit?}
    H --&gt;|no| I(Normal Return)
    H --&gt;|yes| J(Throw process.exit error)
    J --&gt; K{Return error?}
    K --&gt;|yes| L(return thrown error)
    K --&gt;|no| M(throw error)
    L --&gt; N(Reset Overrides)
    M --&gt; N
    I --&gt; N
    N --&gt; O(Test Assertions)</code></pre>
<h3 id="about">About</h3>
<p>In general, when using <code>jest-cli-tester</code>:</p>
<ul>
<li>jest will start running its tests</li>
<li>When a CliRunner.run() is called, the test will override<ul>
<li>process.exit with a function that throws an error</li>
<li>process.argv with arguments like a cli call</li>
<li>Promises with a constructor that can propagate the process.exit error to simulate a process.exit</li>
</ul>
</li>
<li>The test cli script that is run is then run in an isolated context</li>
<li>This means the cli script is guaranteed to reload despite any number of tests of the same script</li>
<li>On each reload, the Cli transformer will run and wrap the script into a module so that run can await it and catch any process.exit errors<ul>
<li>NOTE: we only transform the entrypoint with catch injection at this point - further design would be needed to transform other files.</li>
</ul>
</li>
<li>The process will either throw a process.exit error or return as expected</li>
<li>If an error is thrown, depending on the CLIRunner setting, the <code>run()</code> method will either throw the same error or will return it as a string</li>
<li>Before returning, the CLIRunner will reset its global overrides</li>
</ul>
<h2 id="propagating-processexit">Propagating process.exit()</h2>
<p>Since process.exit is supposed to stop code execution at the moment of
its call, we need to effectively simulate the same behavior without 
endangering the integrity of the application stack (in order to allow
additional tests and assertions).</p>
<p>Because of this, we need to effectively throw a very specific error
when process.exit() is called and then insert handlers within different
contexts to ensure that process.exit() bubbles up to our <code>run()</code> call
before any other code execution.</p>
<p>(Please note, the design is supplied here in an effort to have others
point out if there are contexts that may not work as intended.)</p>
<h3 id="simple-synchronous-context">Simple Synchronous context</h3>
<p><pre class="mermaid"><code>flowchart TD
    A[start sync] --&gt; B("process.exit()")
    B --&gt; C("throw process.exit() error")
    C --&gt; D("run() handles error")</code></pre>
In the simplest case, process.exit() throws an error within a synchronous call and the error is caught by the <code>CliRunner.run()</code> method.</p>
<h3 id="simple-awaited-context">Simple Awaited context</h3>
<pre class="mermaid"><code>flowchart TD
    A[start async] --&gt; B(await some promise)
    B --&gt; C("process.exit()")
    C --&gt; D("throw process.exit() error")
    D --&gt; E("run() catches and handles error")</code></pre>
<p>Just like with the fully synchronous case, if we are using awaited functions, then the behavior is the same as a synchronous context</p>
<h3 id="synchronousawaited-caught-context">Synchronous/Awaited Caught context</h3>
<pre class="mermaid"><code>flowchart TD
    A[synchronous/await&lt;br&gt;throw process.exit error] --&gt; B(catch)
    B --&gt; C{is process exit?}
    C --&gt;|yes| D(rethrow error)
    C --&gt; F(Proceed with normal catch) 
    D --&gt;|if nested| B
    D --&gt; E("run() catches and handles error")</code></pre>
<p>In a synchronous or awaited context, we can see that jest CLI Tester needs to have a hook at the beginning of every catch (and finally) to rethrow any 
process.exit error that may have been caught while also avoiding any additional code running (since we are simulating a process exit).
Ultimately, the error will trickle up to the <code>run()</code> function where CLIRunner can handle it and return accordingly.</p>
<h3 id="detached-async-contexts-ie-promises">Detached Async Contexts (i.e. Promises)</h3>
<p>In a Promise context, we run into a little different problem.  This problem is that we can end up with asynchronous code that
is not awaited and is meant to call the reject() or resolve() functions of another promise at a later context.  In these cases, if we just threw
an error, we would get an uncaught exception or a hanging process because our error bypassed a fulfillment call to the upper level
promise.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Note - this is contrived and is a bad design</span>
<span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">someAsyncMethod</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">something</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="w">            </span><span class="c1">// If you throw an error here</span>
<span class="w">            </span><span class="c1">// the upper promise never resolves :(</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">res</span><span class="p">();</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>For this reason, we override the <code>Promise object</code>.  In part, this is done to:</p>
<ol>
<li>Wrap all but the (await and async generator) promise/then/catch handlers with a short circuit 
   that throws the process exit error if it is globally set</li>
<li>Additionally, wraps all of the previous handlers in try-catches that:</li>
<li>Evaluates if the parent promise is done calling its handler, and throws if it isn't (because we're in a sync/awaited context)</li>
<li>If the promise above is already done with its handler code, we then just call the <code>reject()</code> of the parent promise or just return if
   the promise already had its <code>reject()</code> called</li>
</ol>
<p>Important notes about implementation:</p>
<ul>
<li>Since this is working within the NodeJS native code wrapping system, we actually have to be careful to do these throws and catches
  without sabotaging any wrapping native code for promises.  This is based off of testing and may be refined further if someone has more 
  knowledge.</li>
<li>The implementation is meant to cover best practice patterns for promise usage. In its most general form, throwing from within an awaited
  Promise should work.  If you are doing deeply nested promises where a process exit call is called within some promise that is supposed to 
  resolve a promise many layers up, you may experience hanging tests and we recommend a refactor or at least mocking that section.</li>
</ul>
<p>The flow chart below shows the flow from throwing within a promise.  This coupled with our injection into synchronous try catch language
constructs, means that we should be propagating a process.exit as the first action all the way up to the <code>run()</code> context, thus simulating
process.exit() without corrupting the process.</p>
<pre class="mermaid"><code>flowchart TD
    A[Promise Context&lt;br&gt;throw + set process.exit error] --&gt; B(wrapping catch)
    B --&gt; C{is process exit error?}
    C --&gt;|yes| W{"Is this a new Promise() handler?"}
    W --&gt;|yes| X(reject current promise)
    X --&gt; A
    W --&gt;|no| D{Did above promise synchronously finish?}
    D --&gt; |no| E(rethrow error)
    D --&gt; |yes| F(call above promise's reject)
    F --&gt; G(noop return)
    C --&gt; |no| G
    G --&gt; H(Trigger next thenable)
    E --&gt; H
    H --&gt; I{process exit error set}
    I --&gt;|yes| J(throw process.exit error)
    I --&gt;|no| K(normal code)
    J --&gt; B
    G --&gt; |when no leftover thenable| U
    K --&gt; U("run() catches and handles error")</code></pre>
<h3 id="handling-global-timers">Handling global timers</h3>
<p>Another common pattern that applications can use is to write some timeout and wrap it in a Promise that gets resolved.  In general,
if you are calling process.exit() within these, you already have a non-cleaned up end of program state.  We expect that you have at least
tried awaiting these timers so that you don't have dangling processes.</p>
<p>With that assumption in mind, our handling of timers is:</p>
<pre class="mermaid"><code>flowchart TD
    A("throw process.exit() error in timer") --&gt; B(wrapping catch)
    B --&gt; C{is process exit error?}
    C --&gt;|yes| W{"has above unresolved promise?"}
    W --&gt;|yes| X(reject above promise)
    W --&gt;|no| Y
    X --&gt; Y{is interval?}
    Y --&gt;|yes| Z(clearInterval)
    Z --&gt; AA
    Y --&gt;|no| AA(return)
    C --&gt;|no| D(rethrow error)
</code></pre>
<h3 id="known-edge-cases">Known edge cases</h3>
<p>The entirety of the process.exit() calls within a Promise is, to put it lightly, a slog.
The current tests within <code>src/tests/scripts/asyncCLIScript.ts</code>, show guaranteed patterns for process.exit to work.  However, if you are doing exotic interdependent promise rejection, you may run into issues because process.exit() is not able
to reject all promises via errors:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Combining a promise with an async function and awaiter has </span>
<span class="c1">// not proven reliable to propagate through</span>
<span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">outerRes</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">someCondition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span><span class="w"> </span><span class="c1">// Pretend you somehow got here</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">res</span><span class="p">();</span>
<span class="w">        </span><span class="nx">outerRes</span><span class="p">();</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>If you would like to use this library with something like this,
you would need (and we would recommend) to do your own rejection up 
to a simpler level where process.exit() does not have to reject all
these loosely coupled promises.</p>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">outerRes</span><span class="p">,</span><span class="w"> </span><span class="nx">outerRej</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">rej</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">someCondition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">rej</span><span class="p">(</span><span class="s1">&#39;oh no&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">res</span><span class="p">();</span>
<span class="w">            </span><span class="nx">outerRes</span><span class="p">();</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">outerRej</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;oh no&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">22</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.code.select", "toc.follow", "navigation.top", "navigation.tabs", "navigation.tracking"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.f13b1293.min.js"></script>
      
    
  </body>
</html>